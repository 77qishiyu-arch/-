<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8" />
<title>æ‹çˆ±ä¿®ç½—åœºï½œå¿ƒåŠ¨å¤§æŒ‘æˆ˜ğŸ’¥</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg1:#ff7e5f;--bg2:#feb47b;--accent1:#ff4500;--accent2:#ff1493;
  --card-bg:#fff;--text-dark:#333;--muted:#999;
}
html,body{height:100%}
body{
  font-family:"PingFang SC","Helvetica Neue",Arial,sans-serif;
  background:linear-gradient(135deg,var(--bg1),var(--bg2));
  min-height:100vh;display:flex;align-items:center;justify-content:center;color:#fff;padding:16px;
}
#game{
  width:100%;max-width:520px;background:var(--card-bg);border-radius:28px;padding:22px;box-shadow:0 30px 70px rgba(255,69,0,0.18);
  position:relative;overflow:hidden;opacity:0;transform:scale(0.96);transition:all .45s cubic-bezier(.2,.9,.2,1);
}
#game.ready{opacity:1;transform:scale(1)}
.header{display:flex;align-items:center;justify-content:center;position:relative;margin-bottom:12px}
h1{font-size:26px;font-weight:800;background:linear-gradient(45deg,var(--accent1),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.hot-tag{position:absolute;right:6px;top:-8px;background:linear-gradient(45deg,#ff4500,#ff6347);color:#fff;font-size:12px;padding:4px 10px;border-radius:20px;font-weight:700;box-shadow:0 6px 18px rgba(255,69,0,0.12)}
.top-controls{position:absolute;left:12px;top:12px;display:flex;gap:8px;align-items:center}
.icon-btn{background:rgba(255,105,180,0.06);border:none;padding:8px;border-radius:999px;color:var(--accent2);font-weight:700;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;transition:transform .18s ease,box-shadow .18s}
.icon-btn:active{transform:scale(.96)}
.share-btn{position:absolute;right:14px;bottom:14px;width:50px;height:50px;border-radius:50%;background:linear-gradient(45deg,#ff4500,#ff6347);color:#fff;border:none;font-size:22px;cursor:pointer;box-shadow:0 12px 30px rgba(255,69,0,0.18)}
.mode-desc{color:#ff69b4;font-size:16px;margin-bottom:18px;font-weight:600;text-align:center}
.mode-list{display:flex;flex-direction:column;gap:12px}
.mode-btn{padding:18px;border-radius:20px;border:none;color:#fff;font-size:19px;font-weight:800;cursor:pointer;display:flex;flex-direction:column;align-items:flex-start;gap:6px;box-shadow:0 10px 20px rgba(0,0,0,0.08);transition:transform .18s ease}
.mode-btn small{font-size:13px;opacity:.95;font-weight:600}
.boy-mode{background:linear-gradient(45deg,#1e90ff,#6495ed)}
.girl-mode{background:linear-gradient(45deg,#ff69b4,#ff1493)}
.difficulty-list{display:flex;flex-direction:column;gap:10px;margin-top:6px}
.difficulty-btn{padding:16px;border-radius:18px;border:none;color:#fff;font-size:17px;font-weight:800;cursor:pointer;position:relative;overflow:hidden;box-shadow:0 8px 20px rgba(0,0,0,0.06)}
.difficulty-btn::after{content:attr(data-level);position:absolute;right:14px;top:50%;transform:translateY(-50%);font-size:13px;background:rgba(255,255,255,0.14);padding:4px 8px;border-radius:12px}
.easy{background:linear-gradient(45deg,#9370db,#8a2be2)}
.normal{background:linear-gradient(45deg,#4169e1,#1e90ff)}
.hard{background:linear-gradient(45deg,#00ced1,#008b8b)}
.crazy{background:linear-gradient(45deg,#ff7f50,#ff4500)}
.hell{background:linear-gradient(45deg,#dc143c,#b22222)}
#play{display:none;position:relative;padding-bottom:80px}
.status{display:flex;justify-content:space-between;font-weight:800;margin:10px 0;color:var(--text-dark)}
.progress-bar{width:100%;height:12px;background:#f1f1f1;border-radius:999px;overflow:hidden;margin-bottom:12px;box-shadow:inset 0 2px 6px rgba(0,0,0,0.04)}
.progress{height:100%;background:linear-gradient(45deg,#ff69b4,#ff1493);width:100%;transition:width .5s cubic-bezier(.2,.9,.2,1)}
#story{background:linear-gradient(135deg,#fff8f5,#fff0e6);padding:18px;border-radius:16px;margin-bottom:12px;font-size:17px;color:var(--text-dark);min-height:110px;box-shadow:0 8px 22px rgba(255,105,180,0.06);position:relative}
#story::before{content:"ğŸ’¬";position:absolute;left:14px;top:14px;font-size:20px}
#question{color:var(--accent1);font-weight:800;margin:12px 0;padding-left:8px;font-size:17px}
.options{display:flex;flex-direction:column;gap:12px}
.option{padding:16px;border-radius:14px;border:none;color:#fff;font-size:17px;font-weight:800;cursor:pointer;text-align:left;box-shadow:0 12px 26px rgba(0,0,0,0.08);transition:transform .18s,box-shadow .18s;display:flex;flex-direction:column;gap:6px}
.option:active{transform:translateY(2px)}
.option:disabled{opacity:.7;cursor:not-allowed;transform:none;box-shadow:0 6px 10px rgba(0,0,0,0.05)}
.a{background:linear-gradient(45deg,#6c5ce7,#a29bfe)}
.b{background:linear-gradient(45deg,#00b894,#00a085)}
#result{margin-top:14px;min-height:72px;padding:14px;border-radius:12px;font-weight:700;text-align:center}
.success{background:linear-gradient(135deg,#d4edda,#c3e6cb);color:#155724;border:2px solid #28a745}
.fail{background:linear-gradient(135deg,#f8d7da,#f5c6cb);color:#721c24;border:2px solid #dc3545}
#next{display:none;margin:16px auto 0;width:92%;padding:14px;border-radius:16px;border:none;background:linear-gradient(45deg,#ffb6c1,#ff69b4);color:#fff;font-size:17px;font-weight:900;cursor:pointer;box-shadow:0 12px 28px rgba(255,105,180,0.14)}
.modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);z-index:120;opacity:0;visibility:hidden;transition:all .18s}
.modal.active{opacity:1;visibility:visible}
.modal-content{background:#fff;border-radius:16px;padding:20px;max-width:420px;width:86%;text-align:center;box-shadow:0 30px 60px rgba(0,0,0,0.2);}
.modal-title{font-size:20px;color:var(--accent1);font-weight:900;margin-bottom:10px}
.modal-desc{color:var(--text-dark);font-size:15px;margin-bottom:16px;line-height:1.5}
.modal-actions{display:flex;gap:10px;justify-content:center;margin-top:10px}
.modal-btn{padding:12px 20px;border-radius:12px;border:none;font-weight:800;cursor:pointer;flex:1}
.confirm-btn{background:linear-gradient(45deg,#ff69b4,#ff1493);color:#fff}
.cancel-btn{background:#f5f5f5;color:#333}
#confetti{position:absolute;inset:0;pointer-events:none;z-index:90;display:none}
@media(max-width:420px){
  h1{font-size:22px}
  .mode-btn{font-size:16px;padding:14px}
  .difficulty-btn{font-size:15px;padding:12px}
  #story{font-size:15px;min-height:100px}
  .option{font-size:15px;padding:14px}
}
</style>
</head>
<body>
<div id="game" aria-live="polite">
  <div class="header">
    <h1>æ‹çˆ±ä¿®ç½—åœº ğŸ’”</h1>
    <span class="hot-tag">æŠ–éŸ³çˆ†æ¬¾ğŸ”¥</span>
    <div class="top-controls">
      <button type="button" id="backBtn" class="icon-btn" title="è¿”å›" aria-label="è¿”å›" style="display:none">â†</button>
      <button type="button" id="soundBtn" class="icon-btn" title="éŸ³æ•ˆå¼€å…³" aria-label="éŸ³æ•ˆ">ğŸ”Š</button>
      <button type="button" id="musicBtn" class="icon-btn" title="èƒŒæ™¯éŸ³ä¹" aria-label="éŸ³ä¹">ğŸµ</button>
    </div>
  </div>

  <div id="modeMenu">
    <p class="mode-desc">é€‰æ‹©ä½ çš„æ‹çˆ±è§†è§’ï¼ŒæŒ‘æˆ˜å¿ƒåŠ¨æé™ï¼</p>
    <div class="mode-list">
      <button type="button" class="mode-btn boy-mode" data-mode="boy">ğŸ‘¦ ç”·ç”Ÿæ¨¡å¼ <small>è€ƒéªŒä½ çš„å¥³æœ‹å‹ï¼Œç”œèœœé€šå…³</small></button>
      <button type="button" class="mode-btn girl-mode" data-mode="girl">ğŸ‘§ å¥³ç”Ÿæ¨¡å¼ <small>è€ƒéªŒä½ çš„ç”·æœ‹å‹ï¼Œé«˜ç”œé¢„è­¦</small></button>
    </div>
  </div>

  <div id="difficultyMenu" style="display:none">
    <h2 id="modeTitle" style="text-align:center;font-size:20px;margin-bottom:20px;color:#ff4500"></h2>
    <div class="difficulty-list">
      <button type="button" class="difficulty-btn easy" data-d="0" data-level="Lv1">ğŸ¬ ç”œç”œæ‹çˆ±ï¼ˆæ— å‹åŠ›ï¼‰</button>
      <button type="button" class="difficulty-btn normal" data-d="1" data-level="Lv2">ğŸ’• æ—¥å¸¸æš§æ˜§ï¼ˆå°ç”œå°æ’©ï¼‰</button>
      <button type="button" class="difficulty-btn hard" data-d="2" data-level="Lv3">âš¡ æƒ…ç»ªæ‹‰æ‰¯ï¼ˆé«˜æƒ…å•†è€ƒéªŒï¼‰</button>
      <button type="button" class="difficulty-btn crazy" data-d="3" data-level="Lv4">ğŸ”¥ ä¿®ç½—ç¿»è½¦ï¼ˆæé™æ•‘åœºï¼‰</button>
      <button type="button" class="difficulty-btn hell" data-d="4" data-level="Lv5">ğŸ’€ å‰ä»»åœ°ç‹±ï¼ˆç»ˆææŒ‘æˆ˜ï¼‰</button>
    </div>
  </div>

  <div id="play" style="display:none">
    <div class="status">
      <span id="stageText">ğŸ”¥ --</span>
      <span id="heartText">â¤ï¸ å¿ƒåŠ¨å€¼: 100</span>
    </div>
    <div class="progress-bar"><div class="progress" id="progressBar"></div></div>

    <div id="story" aria-live="polite"></div>
    <div id="question"></div>

    <div class="options">
      <button type="button" id="btnA" class="option a"></button>
      <button type="button" id="btnB" class="option b"></button>
    </div>

    <div id="result" aria-live="assertive"></div>
    <button type="button" id="next">ç»§ç»­ä¸‹ä¸€å…³ â–¶</button>
  </div>

  <button type="button" id="shareMain" class="share-btn" aria-label="åˆ†äº«">ğŸ“¤</button>
  <canvas id="confetti"></canvas>
</div>

<div id="modalRoot"></div>

<script>
'use strict';

const Game = (() => {
  const MAX_LEVELS = 20;
  const STORAGE_KEY = 'lovearena_state_v3';
  const partnerName = { boy: 'å¥³æœ‹å‹', girl: 'ç”·æœ‹å‹' };

  const difficulties = [
    { name: "ç”œç”œæ‹çˆ±", hp: 100 },
    { name: "æ—¥å¸¸æš§æ˜§", hp: 80 },
    { name: "æƒ…ç»ªæ‹‰æ‰¯", hp: 60 },
    { name: "ä¿®ç½—ç¿»è½¦", hp: 50 },
    { name: "å‰ä»»åœ°ç‹±", hp: 40 }
  ];

  // é¢˜ç›®æ¨¡æ¿
  const templates = {
    boy: {
      0: [
        {s:"ä½ å‘äº†ä¸€ä¸ªå¿ƒæƒ…å°è§†é¢‘", q:"å¥¹ä¼šæ€ä¹ˆå›ï¼Ÿ", c:"å¥½å¯çˆ±ï¼ä¸€ç‚¹éƒ½ä¸æ— èŠï½", w:"å“¦", r:"åŠæ—¶å›åº”+å¤¸èµæ˜¯åŸºç¡€"},
        {s:"å¥¹å‘äº†å¼ åƒé¥­çš„ç…§ç‰‡", q:"ä½ ä¼šè¯´ï¼Ÿ", c:"çœ‹èµ·æ¥å¥½å¥½åƒï¼Œä¸‹æ¬¡å¸¦æˆ‘ä¸€èµ·å»ï¼", w:"åƒå§", r:"ä¸»åŠ¨é‚€çº¦æ‹‰è¿‘è·ç¦»"},
        {s:"å¥¹è¯´æƒ³ç¡äº†", q:"ä½ æ€ä¹ˆå›ï¼Ÿ", c:"æ™šå®‰å®è´ï¼Œåšä¸ªç”œç”œçš„æ¢¦ï½", w:"å—¯", r:"æ¸©æŸ”æ™šå®‰æœ€æš–å¿ƒ"},
        {s:"å¥¹å‘äº†ä¸€å¼ è‡ªæ‹", q:"ä½ å›å¤ï¼Ÿ", c:"å“‡ï¼å¤ªå¥½çœ‹äº†ï¼Œæˆ‘çš„å¿ƒéƒ½è¢«å·èµ°äº†", w:"è¿˜è¡Œ", r:"çœŸè¯šå¤¸èµæœ€åŠ¨äºº"},
        {s:"å¥¹åˆ†äº«äº†ä¸€ä¸ªå°å¹¸è¿", q:"ä½ æ€ä¹ˆè¯´ï¼Ÿ", c:"ä¸ºä½ å¼€å¿ƒï¼å¹¸è¿è¦åˆ†äº«æ‰å®Œæ•´ï½", w:"é‚£æŒºå¥½", r:"å…±æƒ…æ˜¯æ„Ÿæƒ…å‚¬åŒ–å‰‚"},
        {s:"å¥¹é—®å‘¨æœ«å¹²å˜›", q:"ä½ è¯´ï¼Ÿ", c:"æƒ³å’Œä½ ä¸€èµ·å»é€›è¡—çœ‹ç”µå½±ï½", w:"è¿˜æ²¡æƒ³å¥½", r:"ä¸»åŠ¨çº¦ä¼šæœ€åŠ åˆ†"},
        {s:"å¥¹å‘è¯­éŸ³è¯´ä»Šå¤©å¥½ç´¯", q:"ä½ å›ï¼Ÿ", c:"è¾›è‹¦å•¦ï¼ŒæŠ±æŠ±ä½ ï¼Œå›æ¥æˆ‘ç»™ä½ æŒ‰æ‘©", w:"é‚£æ—©ç‚¹ç¡", r:"å®é™…å…³æ€€èƒœè¿‡ç©ºè¯"}
      ],
      1: [
        {s:"å¥¹é—®ä½ æœ‰æ²¡æœ‰æƒ³å¥¹", q:"ä½ æ€ä¹ˆç­”ï¼Ÿ", c:"å½“ç„¶æƒ³ï¼Œä¸€åˆ†é’Ÿæ²¡è§å°±æƒ³ä½ ", w:"è¿˜å¥½å§", r:"ç”œè¨€èœœè¯­è¦å¤§èƒ†"},
        {s:"å¥¹å‘äº†ä¸€å¼ ç¾ç¾çš„è‡ªæ‹é—®å¥½çœ‹å—", q:"ä½ è¯´ï¼Ÿ", c:"ç¾åˆ°çŠ¯è§„ï¼æˆ‘æŠ¥è­¦äº†", w:"å¥½çœ‹", r:"å¤¸å¼ å¼å¤¸èµè¶…æœ‰æ•ˆ"},
        {s:"å¥¹æ„Ÿå¹æ—¶é—´è¿‡å¾—çœŸå¿«", q:"ä½ æ¥ï¼Ÿ", c:"å’Œä½ åœ¨ä¸€å¤©å°±è¿‡å¾—ç‰¹åˆ«å¿«ï½", w:"æ˜¯å•Š", r:"æŠŠè¯é¢˜è½¬åˆ°æ„Ÿæƒ…"},
        {s:"å¥¹è¯´æƒ³åƒç«é”…", q:"ä½ å›å¤ï¼Ÿ", c:"èµ°ï¼ç°åœ¨å°±å¸¦ä½ å»åƒ", w:"ä¸‹æ¬¡å§", r:"å³æ—¶è¡ŒåŠ¨æœ€æµªæ¼«"},
        {s:"å¥¹å‘äº†ä¸€ä¸ªå¯çˆ±è¡¨æƒ…åŒ…", q:"ä½ æ€ä¹ˆå›ï¼Ÿ", c:"å“ˆå“ˆå“ˆä½ æ€ä¹ˆè¿™ä¹ˆå¯çˆ±ï¼", w:"å—¯", r:"ç§¯æäº’åŠ¨å‡æ¸©å¿«"},
        {s:"å¥¹é—®ä½ åœ¨å¹²å˜›", q:"æœ€ä½³å›å¤ï¼Ÿ", c:"åœ¨æƒ³æˆ‘çš„å°å®è´å‘€ï½", w:"ä¸Šç­å‘¢", r:"ç”œèœœåé—®æ›´æ’©äºº"}
      ],
      2: [
        {s:"å¥¹ä»Šå¤©å›å¤å¾ˆæ…¢ï¼Œè¯­æ°”å†·æ·¡", q:"ä½ æ€ä¹ˆå…³å¿ƒï¼Ÿ", c:"å®è´æ€ä¹ˆäº†ï¼Ÿæ˜¯ä¸æ˜¯å¿ƒæƒ…ä¸å¥½ï¼Œå’Œæˆ‘è¯´è¯´", w:"æ€ä¹ˆä¸å›æˆ‘äº†", r:"å…ˆå…³å¿ƒåè¯¢é—®æ›´ç¨³"},
        {s:"å¥¹è¯´ä½ æœ€è¿‘ä¸æ€ä¹ˆæ‰¾å¥¹", q:"ä½ æ€ä¹ˆè§£é‡Šï¼Ÿ", c:"å¯¹ä¸èµ·ï¼Œæ˜¯æˆ‘ä¸å¥½ï¼Œè®©ä½ è§‰å¾—è¢«å¿½è§†äº†", w:"æˆ‘å¾ˆå¿™å•Š", r:"è®¤é”™æ¯”è¾©è§£æœ‰ç”¨"},
        {s:"å¥¹å·¥ä½œå‹åŠ›å¤§æŠ±æ€¨äº†ä¸€å¥", q:"ä½ è¯´ï¼Ÿ", c:"è¾›è‹¦äº†ï¼Œæˆ‘åœ¨å‘¢ï¼Œæƒ³æŠ±æŠ±ä½ ", w:"é‚£å°±å¿å¿å§", r:"é™ªä¼´èƒœè¿‡é¸¡æ±¤"},
        {s:"å¥¹çœ‹åˆ°ä½ ç‚¹èµäº†åˆ«çš„å¥³ç”Ÿç…§ç‰‡", q:"ä½ æ€ä¹ˆå®‰æŠšï¼Ÿ", c:"åªæ˜¯éšæ‰‹ç‚¹çš„ï¼Œä½ åƒé†‹çš„æ ·å­å¥½å¯çˆ±ï½", w:"åˆä¸æ˜¯ä»€ä¹ˆ", r:"è½»ææ·¡å†™+åæ’©æœ€ä¼˜"},
        {s:"å¥¹åŠå¤œå‘æ¶ˆæ¯è¯´ç¡ä¸ç€", q:"ä½ å›ï¼Ÿ", c:"æˆ‘é™ªä½ èŠåˆ°ç¡ç€ï¼Œå¥½ä¸å¥½ï¼Ÿ", w:"é‚£ä½ æ•°ç¾Šå§", r:"ä¸»åŠ¨é™ªä¼´æœ€æš–"},
        {s:"å¥¹è¯´æƒ³å®‰é™å‡ å¤©", q:"ä½ æ€ä¹ˆåšï¼Ÿ", c:"å¥½ï¼Œæˆ‘ç»™ä½ ç©ºé—´ï¼Œä½†éšæ—¶æ‰¾æˆ‘å“¦", w:"éšä¾¿ä½ ", r:"å°Šé‡+ç•™åè·¯æœ€æˆç†Ÿ"}
      ],
      3: [
        {s:"å¥¹å‘ç°ä½ æ‰‹æœºé‡Œæœ‰å‰ä»»çš„èŠå¤©è®°å½•", q:"ä½ æ€ä¹ˆå¤„ç†ï¼Ÿ", c:"è¿™æ˜¯ä»¥å‰çš„ï¼Œæˆ‘ç°åœ¨å½“ç€ä½ é¢åˆ æ‰", w:"åˆä¸æ˜¯ä»€ä¹ˆå¤§äº‹", r:"æœæ–­æ¸…ç†ç»™å®‰å…¨æ„Ÿ"},
        {s:"å¥¹ç”Ÿæ°”è¯´ä½ ä¸é‡è§†å¥¹", q:"ä½ æ€ä¹ˆæŒ½å›ï¼Ÿ", c:"æ˜¯æˆ‘ä¸å¯¹ï¼Œæˆ‘æ„¿æ„æ”¹ï¼Œä½ åˆ«ç”Ÿæ°”äº†å¥½ä¸å¥½", w:"ä½ åˆå°é¢˜å¤§åš", r:"ä½å§¿æ€æœ€æœ‰æ•ˆ"},
        {s:"å¥¹çœ‹åˆ°ä½ å’Œå¼‚æ€§åŒäº‹åˆç…§", q:"ä½ è§£é‡Šï¼Ÿ", c:"å°±æ˜¯æ™®é€šåŒäº‹ï¼Œåˆ«å¤šæƒ³ï¼Œæˆ‘åªå–œæ¬¢ä½ ", w:"ä½ ç®¡å¾—å¤ªå®½äº†", r:"åšå®šè¡¨å¿ å¿ƒæœ€é‡è¦"},
        {s:"å¥¹è´¨é—®ä½ ä¸ºä»€ä¹ˆä¸æ¥ç”µè¯", q:"ä½ è¯´ï¼Ÿ", c:"å¯¹ä¸èµ·æ‰‹æœºé™éŸ³äº†ï¼Œæˆ‘ç°åœ¨æ‰“ç»™ä½ ", w:"åœ¨å¿™å‘¢", r:"ä¸»åŠ¨è¡¥æ•‘æœ€çœŸè¯š"},
        {s:"å¥¹å†·æˆ˜äº†ä¸¤å¤©", q:"ä½ æ€ä¹ˆç ´å†°ï¼Ÿ", c:"å®è´ï¼Œæˆ‘é”™äº†ï¼Œæˆ‘ä»¬å¥½å¥½è°ˆè°ˆå¥½å—", w:"ç­‰å¥¹è‡ªå·±è”ç³»", r:"ä¸»åŠ¨è®¤é”™æœ€å¿«å’Œå¥½"},
        {s:"å¥¹è¯´è€ƒè™‘åˆ†æ‰‹", q:"ä½ æ€ä¹ˆç•™ï¼Ÿ", c:"åˆ«æ€¥ç€å†³å®šï¼Œæˆ‘ä¸æƒ³å¤±å»ä½ ï¼Œæˆ‘ä»¬å†è¯•è¯•", w:"é‚£å°±åˆ†å§", r:"çœŸè¯šæŒ½ç•™æœ€åŠ¨äºº"}
      ],
      4: [
        {s:"å‰ä»»çªç„¶åŠ ä½ å¾®ä¿¡", q:"ä½ æ€ä¹ˆåšï¼Ÿ", c:"ç›´æ¥æ‹’ç»å¹¶å‘Šè¯‰å¥¹ï¼šæˆ‘ç°åœ¨æœ‰å¥³æœ‹å‹", w:"å…ˆåŠ ä¸Šçœ‹çœ‹", r:"ç«‹åœºåšå®šæœ€é‡è¦"},
        {s:"å¥¹å‘ç°ä½ æ²¡åˆ å‰ä»»ç…§ç‰‡", q:"ä½ ååº”ï¼Ÿ", c:"æˆ‘ç°åœ¨å°±åˆ ï¼Œä½ åˆ«ä¸é«˜å…´", w:"åˆä¸æ˜¯è”ç³»", r:"ç«‹å³è¡ŒåŠ¨ç»™ä¿¡ä»»"},
        {s:"å‰ä»»å‘æ¶ˆæ¯è¯´æƒ³ä½ äº†", q:"ä½ æ€ä¹ˆå›å¥¹ï¼Ÿ", c:"æˆ‘æœ‰å¥³æœ‹å‹äº†ï¼Œè¯·ä¸è¦å†è”ç³»", w:"å·²è¯»ä¸å›", r:"æ˜ç¡®æ‹’ç»æ›´è´Ÿè´£"},
        {s:"å¥¹é—®ä½ ä¼šä¸ä¼šå’Œå‰ä»»å¤åˆ", q:"ä½ è¯´ï¼Ÿ", c:"ä¸å¯èƒ½ï¼Œæˆ‘åªæƒ³å’Œä½ è¿‡ä¸€è¾ˆå­", w:"çœ‹æƒ…å†µå§", r:"åšå®šè¡¨æ€æœ€å®‰å¿ƒ"},
        {s:"å‰ä»»å½“ç€å¥¹çš„é¢è”ç³»ä½ ", q:"ä½ æ€ä¹ˆå¤„ç†ï¼Ÿ", c:"å½“åœºæ‹‰é»‘ï¼Œå¹¶æŠ±æŠ±å¥¹è¯´åªæœ‰ä½ ", w:"äº‹åè§£é‡Š", r:"å…¬å¼€æŠ¤çˆ±æœ€åŠ åˆ†"},
        {s:"å¥¹å“­ç€è¯´å®³æ€•å¤±å»ä½ ", q:"ä½ æ€ä¹ˆå®‰æ…°ï¼Ÿ", c:"æˆ‘ä¸ä¼šè®©ä½ å¤±å»æˆ‘ï¼Œæˆ‘ä¼šç”¨è¡ŒåŠ¨è¯æ˜", w:"åˆ«çæƒ³", r:"æ‰¿è¯º+è¡ŒåŠ¨æœ€æœ‰åŠ›"}
      ]
    },
    girl: {
      0: [
        {s:"ä»–å‘æ¥æç¬‘è¡¨æƒ…åŒ…", q:"ä½ æ€ä¹ˆå›ï¼Ÿ", c:"å“ˆå“ˆå“ˆä½ ç¬‘æ­»æˆ‘äº†ï¼Œå¤ªå¯çˆ±äº†ï¼", w:"å—¯", r:"ç§¯æäº’åŠ¨æœ€åŠ åˆ†"},
        {s:"ä»–è¯´æƒ³åƒä½ åšçš„é¥­", q:"ä½ è¯´ï¼Ÿ", c:"å¥½å‘€ï¼Œå‘¨æœ«æ¥æˆ‘å®¶æˆ‘åšç»™ä½ åƒï½", w:"éšä¾¿åƒç‚¹å§", r:"ä¸»åŠ¨é‚€çº¦è¶…ç”œ"},
        {s:"ä»–è¯´ä»Šå¤©å¥½ç´¯", q:"ä½ å›ï¼Ÿ", c:"è¾›è‹¦å•¦å®è´ï¼ŒæŠ±æŠ±ä½ ï¼Œå›æ¥æˆ‘ç»™ä½ æŒ‰æ‘©", w:"é‚£æ—©ç‚¹ä¼‘æ¯", r:"ä½“è´´å…³æ€€æœ€æš–"},
        {s:"ä»–å‘è‡ªæ‹é—®å¸…ä¸å¸…", q:"ä½ å›å¤ï¼Ÿ", c:"å¸…çˆ†äº†ï¼æˆ‘è¦è—èµ·æ¥ä¸è®©åˆ«äººçœ‹", w:"å¸…", r:"å¤¸å¼ å¼å¤¸èµæœ€æœ‰æ•ˆ"},
        {s:"ä»–è¯´æƒ³ä½ äº†", q:"ä½ æ€ä¹ˆæ¥ï¼Ÿ", c:"æˆ‘ä¹Ÿå¥½æƒ³ä½ ï¼ŒæŠ±æŠ±ï½å¿«ç‚¹æ¥è§æˆ‘", w:"å“¦", r:"çƒ­æƒ…å›åº”æœ€æ’©äºº"},
        {s:"ä»–é—®å‘¨æœ«æœ‰ç©ºå—", q:"ä½ è¯´ï¼Ÿ", c:"æœ‰ç©ºï¼æƒ³å’Œä½ ä¸€èµ·å‡ºå»ç©", w:"çœ‹æƒ…å†µ", r:"ä¸»åŠ¨æœ€æµªæ¼«"}
      ],
      1: [
        {s:"ä»–å‘äº†ä¸€å¼ å¸…æ°”çš„è‡ªæ‹", q:"é«˜ç”œå›å¤ï¼Ÿ", c:"å¤©å“ªå¤ªå¸…äº†ï¼Œæˆ‘è¦æ™•å€’äº†", w:"ä¸é”™", r:"å¤§èƒ†å¤¸èµæœ€åŠ¨äºº"},
        {s:"ä»–è¯´åˆšä¸‹ç­", q:"ä½ å›ï¼Ÿ", c:"è¾›è‹¦å•¦ï¼Œå¿«å›æ¥æˆ‘ç»™ä½ å‡†å¤‡äº†æƒŠå–œï½", w:"å—¯æ—©ç‚¹ç¡", r:"å°æƒŠå–œæœ€æ¸©é¦¨"},
        {s:"ä»–åˆ†äº«å·¥ä½œä¸Šçš„å¼€å¿ƒäº‹", q:"ä½ è¯´ï¼Ÿ", c:"å¤ªæ£’äº†ï¼ä¸ºä½ éª„å‚²ï¼Œæ™šä¸Šå¥–åŠ±ä½ ", w:"å‰å®³", r:"åŒæ­¥æƒ…ç»ªæ›´äº²å¯†"},
        {s:"ä»–é—®ä½ åœ¨å¹²å˜›", q:"ä½ å›å¤ï¼Ÿ", c:"åœ¨æƒ³æˆ‘çš„å¸…ç”·å‹å‘€ï½", w:"åƒé¥­å‘¢", r:"åæ’©æœ€ç”œ"},
        {s:"ä»–è¯´æƒ³æŠ±ä½ ", q:"ä½ æ€ä¹ˆå›ï¼Ÿ", c:"æˆ‘ä¹Ÿæƒ³æŠ±æŠ±ä½ ï¼Œå¿«ç‚¹æ¥æ‰¾æˆ‘", w:"å—¯", r:"çƒ­æƒ…å›åº”å‡æ¸©å¿«"}
      ],
      2: [
        {s:"ä»–å›å¤æ¶ˆæ¯å¾ˆæ…¢", q:"ä½ æ€ä¹ˆä¸å°´å°¬ï¼Ÿ", c:"å¿™åäº†å§ï¼Ÿåˆ«å¤ªç´¯äº†ï¼Œè®°å¾—å–æ°´ï½", w:"ä½ åœ¨å¹²å˜›å•Š", r:"æ¸©æŸ”ç†è§£æ›´å¸å¼•"},
        {s:"ä»–è¯´å¯èƒ½ä¼šæ™šå½’", q:"ä½ å›ï¼Ÿ", c:"æ³¨æ„å®‰å…¨ï¼Œåˆ°äº†å‘Šè¯‰æˆ‘ä¸€å£°ï¼Œæ™šå®‰", w:"éšä¾¿ä½ ", r:"ä¿¡ä»»+å…³å¿ƒæœ€ç¨³"},
        {s:"ä»–æƒ…ç»ªä½è½", q:"ä½ æ€ä¹ˆåšï¼Ÿ", c:"æˆ‘åœ¨å‘¢ï¼Œæƒ³èŠå°±æ‰¾æˆ‘ï¼Œæˆ‘ä¸€ç›´å¬ç€", w:"é‚£ä½ è‡ªå·±æƒ³å§", r:"é™ªä¼´èƒœè¿‡é€¼é—®"},
        {s:"ä»–å¿˜äº†å›ä½ æ¶ˆæ¯", q:"ä½ è¯´ï¼Ÿ", c:"æ²¡äº‹å•¦ï¼Œè‚¯å®šæ˜¯å¿™æ™•äº†ï¼ŒæŠ±æŠ±", w:"ä¸ºä»€ä¹ˆä¸å›æˆ‘", r:"å¤§åº¦æœ€æœ‰é­…åŠ›"},
        {s:"ä»–è¯´å‹åŠ›å¤§", q:"ä½ å®‰æ…°ï¼Ÿ", c:"è¾›è‹¦äº†ï¼Œæˆ‘åœ¨ä½ èº«è¾¹ï¼Œåˆ«ç¡¬æ‰›", w:"åŠ æ²¹", r:"å®é™…é™ªä¼´æ›´é‡è¦"}
      ],
      3: [
        {s:"ä½ å‘ç°ä»–ç‚¹èµäº†å‰ä»»åŠ¨æ€", q:"ä½ æ€ä¹ˆåº”å¯¹ï¼Ÿ", c:"æœ‰ç‚¹åƒé†‹ï¼Œä½†ç›¸ä¿¡ä½ ï¼ŒæŠ±æŠ±æˆ‘å˜›ï½", w:"ä½ ä»€ä¹ˆæ„æ€", r:"è¡¨è¾¾æ„Ÿå—+æ’’å¨‡æœ€ä¼˜"},
        {s:"ä»–å†·æš´åŠ›ä¸€å¤©", q:"ä½ æ€ä¹ˆç ´å†°ï¼Ÿ", c:"å®è´ï¼Œæ˜¯ä¸æ˜¯æˆ‘å“ªé‡Œåšå¾—ä¸å¥½ï¼Ÿæˆ‘ä»¬è°ˆè°ˆ", w:"éšä¾¿ä½ ", r:"ä¸»åŠ¨æ²Ÿé€šæœ€æˆç†Ÿ"},
        {s:"ä»–å¿˜äº†çºªå¿µæ—¥", q:"ä½ å›åº”ï¼Ÿ", c:"è™½ç„¶æœ‰ç‚¹å¤±è½ï¼Œä½†æ›´å¼€å¿ƒä½ è¿˜åœ¨æˆ‘èº«è¾¹", w:"ä½ æ€ä¹ˆå¿˜äº†ï¼", r:"ä»¥æƒ…åŠ¨äººæ›´å®¹æ˜“"},
        {s:"ä»–å’Œå¼‚æ€§æœ‹å‹èµ°å¾—å¾ˆè¿‘", q:"ä½ è¯´ï¼Ÿ", c:"æˆ‘æœ‰ç‚¹ä¸èˆ’æœï¼Œèƒ½ä¸èƒ½å¤šæ³¨æ„æˆ‘çš„æ„Ÿå—", w:"ä½ ç®¡å¤ªå¤šäº†", r:"è¡¨è¾¾éœ€æ±‚ä¸æŒ‡è´£"},
        {s:"ä»–å¿ƒæƒ…ä¸å¥½å‘è„¾æ°”", q:"ä½ æ€ä¹ˆåšï¼Ÿ", c:"æˆ‘çŸ¥é“ä½ ä¸æ˜¯æ•…æ„çš„ï¼Œæˆ‘åœ¨å‘¢ï¼ŒæŠ±æŠ±", w:"ä½ å¹²ä»€ä¹ˆ", r:"åŒ…å®¹æœ€æ²»æ„ˆ"}
      ],
      4: [
        {s:"å‰ä»»åŠ ä½ å¥½å‹è¯´æƒ³å¤åˆ", q:"ä½ æ€ä¹ˆå¤„ç†ï¼Ÿ", c:"ç›´æ¥æ‹’ç»å¹¶å‘Šè¯‰ä»–ï¼šæˆ‘ç°åœ¨å¾ˆå¹¸ç¦", w:"å…ˆçœ‹çœ‹", r:"ç«‹åœºåšå®šæœ€é‡è¦"},
        {s:"ä»–è¢«å‰ä»»çº ç¼ ", q:"ä½ æ€ä¹ˆæ”¯æŒï¼Ÿ", c:"æˆ‘å’Œä½ ä¸€èµ·é¢å¯¹ï¼Œåˆ«æ‹…å¿ƒï¼Œæœ‰æˆ‘å‘¢", w:"ä½ è‡ªå·±å¤„ç†", r:"å…±åŒé¢å¯¹æœ€ç¨³å›º"},
        {s:"ä»–æ‰‹æœºé‡Œæœ‰å‰ä»»ç…§ç‰‡", q:"ä½ è¯´ï¼Ÿ", c:"æˆ‘æœ‰ç‚¹éš¾è¿‡ï¼Œèƒ½ä¸èƒ½åˆ æ‰ï¼Ÿæˆ‘ä¼šæ›´å®‰å¿ƒ", w:"éšä¾¿ä½ çœ‹", r:"è¡¨è¾¾æ„Ÿå—+è¯·æ±‚æœ€ä¼˜"},
        {s:"å‰ä»»é€ è°£ä½ ä»¬å…³ç³»", q:"ä½ æ€ä¹ˆåšï¼Ÿ", c:"æˆ‘ä»¬ä¸€èµ·æ¾„æ¸…ï¼Œæˆ‘ç›¸ä¿¡ä½ ", w:"åˆ«ç†å¥¹", r:"å¹¶è‚©ä½œæˆ˜æœ€åŠ åˆ†"},
        {s:"ä»–çŠ¹è±«æ˜¯å¦åˆ å‰ä»»è”ç³»æ–¹å¼", q:"ä½ æ€åº¦ï¼Ÿ", c:"æˆ‘ç›¸ä¿¡ä½ çš„é€‰æ‹©ï¼Œä½†å¸Œæœ›ä½ ä¸ºæˆ‘ä»¬ç€æƒ³", w:"å¿…é¡»åˆ ", r:"ä¿¡ä»»+å¼•å¯¼æ›´é«˜çº§"}
      ]
    }
  };

  // DOM
  const $ = id => document.getElementById(id);
  const els = {
    game: $('game'),
    backBtn: $('backBtn'),
    soundBtn: $('soundBtn'),
    musicBtn: $('musicBtn'),
    modeMenu: $('modeMenu'),
    difficultyMenu: $('difficultyMenu'),
    modeTitle: $('modeTitle'),
    play: $('play'),
    stageText: $('stageText'),
    heartText: $('heartText'),
    progressBar: $('progressBar'),
    story: $('story'),
    question: $('question'),
    btnA: $('btnA'),
    btnB: $('btnB'),
    result: $('result'),
    next: $('next'),
    shareMain: $('shareMain'),
    modalRoot: $('modalRoot'),
    confetti: $('confetti')
  };

  // çŠ¶æ€ï¼ˆæ”¯æŒå¤šå­˜æ¡£ï¼‰
  let state = {
    mode: '',
    difficulty: -1,
    hp: 100,
    maxHp: 100,
    current: 0,
    levels: [],
    bestRecord: { boy: [0,0,0,0,0], girl: [0,0,0,0,0] },
    soundOn: true,
    musicOn: false
  };

  // éŸ³é¢‘
  const audioURLs = {
    click: 'https://cdn.jsdelivr.net/gh/yyu8881/demo-assets/click.mp3',
    success: 'https://cdn.jsdelivr.net/gh/yyu8881/demo-assets/success.mp3',
    fail: 'https://cdn.jsdelivr.net/gh/yyu8881/demo-assets/fail.mp3',
    win: 'https://cdn.jsdelivr.net/gh/yyu8881/demo-assets/win.mp3',
    lose: 'https://cdn.jsdelivr.net/gh/yyu8881/demo-assets/lose.mp3',
    bg: 'https://cdn.jsdelivr.net/gh/yyu8881/demo-assets/ambient.mp3'
  };
  const sounds = {};
  let bgMusic = null;

  function preloadAudio() {
    Object.entries(audioURLs).forEach(([key, url]) => {
      if (key === 'bg') return;
      const a = new Audio(url);
      a.preload = 'auto';
      sounds[key] = a;
    });
    bgMusic = new Audio(audioURLs.bg);
    bgMusic.loop = true;
    bgMusic.volume = 0.15;
  }

  function playSFX(key) {
    if (!state.soundOn || !sounds[key]) return;
    sounds[key].currentTime = 0;
    sounds[key].play().catch(() => {});
  }

  function toggleBG() {
    state.musicOn = !state.musicOn;
    els.musicBtn.textContent = state.musicOn ? 'ğŸµ' : 'ğŸ”ˆ';
    if (state.musicOn) {
      bgMusic?.play().catch(() => {});
    } else {
      bgMusic?.pause();
    }
    saveState();
  }

  // å·¥å…·
  function saveState() {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    } catch (e) {
      // ignore storage errors for now
    }
  }

  function loadState() {
    try {
      const saved = localStorage.getItem(STORAGE_KEY);
      if (saved) {
        const parsed = JSON.parse(saved);
        Object.assign(state, parsed);
        if (!state.bestRecord) state.bestRecord = { boy: [0,0,0,0,0], girl: [0,0,0,0,0] };
      }
    } catch (e) {}
  }

  function buildLevels(mode, diff) {
    const base = templates[mode][diff] || [];
    const levels = [];
    for (let i = 0; i < MAX_LEVELS; i++) {
      const tpl = base[i % base.length];
      levels.push({ ...tpl });
    }
    return levels;
  }

  function updateBestRecord() {
    const { mode, difficulty, current } = state;
    if (current + 1 > state.bestRecord[mode][difficulty]) {
      state.bestRecord[mode][difficulty] = current + 1;
      saveState();
    }
  }

  // UI åˆ‡æ¢
  function showModeMenu() {
    els.modeMenu.style.display = '';
    els.difficultyMenu.style.display = 'none';
    els.play.style.display = 'none';
    els.backBtn.style.display = 'none';
    bgMusic?.pause();
  }

  function showDifficulty(mode) {
    playSFX('click');
    state.mode = mode;
    els.modeMenu.style.display = 'none';
    els.difficultyMenu.style.display = '';
    els.backBtn.style.display = '';
    els.modeTitle.innerHTML = `ã€${partnerName[mode]}æ¨¡å¼ã€‘<br><small>é€‰æ‹©æŒ‘æˆ˜éš¾åº¦</small>`;
    if (state.musicOn) bgMusic?.play().catch(() => {});
    saveState();
  }

  function startGame(diff) {
    playSFX('click');
    state.difficulty = diff;
    state.maxHp = difficulties[diff].hp;
    state.hp = state.maxHp;
    state.current = 0;
    state.levels = buildLevels(state.mode, diff);

    els.difficultyMenu.style.display = 'none';
    els.play.style.display = '';
    renderCurrent();
    if (state.musicOn) bgMusic?.play().catch(() => {});
    saveState();
  }

  function renderCurrent() {
    const { current, levels, hp, maxHp, mode, difficulty } = state;
    const lev = levels[current];

    els.stageText.textContent = `ç¬¬ ${current + 1}/${MAX_LEVELS} å…³ Â· ${difficulties[difficulty].name}`;
    els.heartText.textContent = `â¤ï¸ å¿ƒåŠ¨å€¼: ${hp}/${maxHp}`;
    els.progressBar.style.width = `${(hp / maxHp) * 100}%`;

    // ä½¿ç”¨ textContent æ›´å®‰å…¨
    els.story.textContent = `ã€ä½ çš„${partnerName[mode]}ã€‘${lev.s}`;
    els.question.textContent = lev.q;

    const isACorrect = Math.random() < 0.5;
    els.btnA.textContent = `A: ${isACorrect ? lev.c : lev.w}`;
    els.btnB.textContent = `B: ${isACorrect ? lev.w : lev.c}`;

    els.btnA.disabled = els.btnB.disabled = false;
    els.result.innerHTML = '';
    els.next.style.display = 'none';

    state.lastCorrectIndex = isACorrect ? 0 : 1;
  }

  let chooseLocked = false;
  function choose(index) {
    if (chooseLocked) return;
    chooseLocked = true;
    setTimeout(() => { chooseLocked = false; }, 600);

    els.btnA.disabled = els.btnB.disabled = true;
    playSFX('click');

    const lev = state.levels[state.current];
    const correct = index === state.lastCorrectIndex;

    if (correct) {
      playSFX('success');
      state.hp = Math.min(state.maxHp, state.hp + 10);
      els.result.innerHTML = `<div class="success">ğŸ’– æ­£ç¡®ï¼å¿ƒåŠ¨å€¼ +10<br><small>${lev.r}</small></div>`;
    } else {
      playSFX('fail');
      state.hp = Math.max(0, state.hp - 20);
      els.result.innerHTML = `<div class="fail">ğŸ’¥ é”™è¯¯ï¼å¿ƒåŠ¨å€¼ -20<br>æ­£ç¡®ç­”æ¡ˆï¼š${lev.c}</div>`;
      if (state.hp <= 0) {
        setTimeout(gameOver, 800);
        return;
      }
    }

    els.heartText.textContent = `â¤ï¸ å¿ƒåŠ¨å€¼: ${state.hp}/${state.maxHp}`;
    els.progressBar.style.width = `${(state.hp / state.maxHp) * 100}%`;
    els.next.style.display = 'block';
    saveState();
  }

  function nextLevel() {
    playSFX('click');
    state.current++;
    if (state.current >= MAX_LEVELS) {
      updateBestRecord();
      playSFX('win');
      showConfetti();
      const nextDiff = state.difficulty + 1;
      const title = `ğŸ‰ é€šå…³ï¼ç¬¬20å…³å®Œç¾æ‹¿ä¸‹ï¼<br>ä½ æ˜¯çœŸæ­£çš„æ‹çˆ±å¤§å¸ˆï¼`;
      const desc = nextDiff < 5 
        ? `è¦æŒ‘æˆ˜æ›´éš¾çš„ã€${difficulties[nextDiff].name}ã€‘å—ï¼Ÿ`
        : `æ‰€æœ‰éš¾åº¦å·²é€šå…³ï¼ä½ å°±æ˜¯æ‹çˆ±å¤©èŠ±æ¿ğŸ†`;
      showModal(title, desc, 
        nextDiff < 5 ? () => startGame(nextDiff) : shareGame,
        () => location.reload()
      );
    } else {
      renderCurrent();
    }
  }

  function gameOver() {
    updateBestRecord();
    playSFX('lose');
    const reached = state.current + 1;
    showModal(
      `ğŸ’” å¿ƒåŠ¨å€¼å½’é›¶äº†...<br>æœ¬æ¬¡æŒ‘æˆ˜åˆ°ç¬¬ ${reached} å…³`,
      `å†æ¥ä¸€æ¬¡ï¼Œç›¸ä¿¡ä½ èƒ½èµ°å¾—æ›´è¿œï¼`,
      () => startGame(state.difficulty),
      showModeMenu
    );
  }

  function showModal(titleHTML, descHTML = '', onConfirm, onCancel) {
    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.innerHTML = `
      <div class="modal-content" role="dialog" aria-modal="true">
        <div class="modal-title">${titleHTML}</div>
        <div class="modal-desc">${descHTML}</div>
        <div class="modal-actions">
          <button type="button" class="modal-btn confirm-btn">ç¡®å®š</button>
          <button type="button" class="modal-btn cancel-btn">å–æ¶ˆ</button>
        </div>
      </div>
    `;
    els.modalRoot.appendChild(modal);

    const confirmBtn = modal.querySelector('.confirm-btn');
    const cancelBtn = modal.querySelector('.cancel-btn');

    confirmBtn.onclick = () => {
      playSFX('click');
      modal.remove();
      onConfirm?.();
    };
    cancelBtn.onclick = () => {
      playSFX('click');
      modal.remove();
      onCancel?.();
    };

    // ç‚¹å‡»é®ç½©å…³é—­ï¼ˆç‚¹å‡»åˆ° modal èƒŒæ™¯ï¼‰
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        playSFX('click');
        modal.remove();
        onCancel?.();
      }
    });

    // ESC ä¹Ÿèƒ½å…³é—­
    function onKey(e) {
      if (e.key === 'Escape') {
        playSFX('click');
        modal.remove();
        onCancel?.();
        document.removeEventListener('keydown', onKey);
      }
    }
    document.addEventListener('keydown', onKey);

    // ç®€å•ç„¦ç‚¹ç®¡ç†
    confirmBtn.focus();
  }

  function shareGame() {
    const best = state.bestRecord[state.mode][state.difficulty] || 0;
    const text = `æˆ‘åœ¨ã€Šæ‹çˆ±ä¿®ç½—åœºã€‹${partnerName[state.mode]}æ¨¡å¼Â·${difficulties[state.difficulty].name}é€šå…³äº†${best}å…³ï¼å¿«æ¥æŒ‘æˆ˜æˆ‘ï½`;
    const url = location.href;

    if (navigator.share) {
      navigator.share({ title: 'æ‹çˆ±ä¿®ç½—åœº', text, url }).catch(() => {});
    } else if (navigator.clipboard) {
      navigator.clipboard.writeText(url).then(() => {
        alert('é“¾æ¥å·²å¤åˆ¶ï¼å¿«å»åˆ†äº«ç»™æœ‹å‹ä¸€èµ·ç©ï½');
      }).catch(() => {
        alert('è¯·æ‰‹åŠ¨å¤åˆ¶é“¾æ¥åˆ†äº«ï¼š' + url);
      });
    } else {
      alert('è¯·æ‰‹åŠ¨å¤åˆ¶é“¾æ¥åˆ†äº«ï¼š' + url);
    }
  }

  function showConfetti() {
    const canvas = els.confetti;
    canvas.style.display = 'block';
    const ctx = canvas.getContext('2d');
    // æ›´ç¨³å¥çš„å°ºå¯¸è®¡ç®—
    const rect = canvas.getBoundingClientRect();
    canvas.width = Math.max(1, Math.floor(rect.width));
    canvas.height = Math.max(1, Math.floor(rect.height));

    const pieces = [];
    const colors = ['#ff6b6b','#ffd93d','#6bcf7f','#4d79ff','#a56eff','#ff8ab8'];
    for (let i = 0; i < 100; i++) {
      pieces.push({
        x: Math.random() * canvas.width,
        y: Math.random() * canvas.height - canvas.height,
        size: Math.random() * 10 + 5,
        speed: Math.random() * 4 + 2,
        color: colors[Math.floor(Math.random() * colors.length)],
        rotation: Math.random() * 360,
        spin: Math.random() * 10 - 5
      });
    }

    let anim;
    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      pieces.forEach(p => {
        p.y += p.speed;
        p.rotation += p.spin;
        ctx.save();
        ctx.translate(p.x, p.y);
        ctx.rotate(p.rotation * Math.PI / 180);
        ctx.fillStyle = p.color;
        ctx.fillRect(-p.size/2, -p.size/2, p.size, p.size * 0.5);
        ctx.restore();
      });
      if (pieces.some(p => p.y < canvas.height)) {
        anim = requestAnimationFrame(draw);
      } else {
        cancelAnimationFrame(anim);
        canvas.style.display = 'none';
      }
    }
    draw();
  }

  // åˆå§‹åŒ–
  function init() {
    preloadAudio();
    loadState();

    els.soundBtn.textContent = state.soundOn ? 'ğŸ”Š' : 'ğŸ”‡';
    els.musicBtn.textContent = state.musicOn ? 'ğŸµ' : 'ğŸ”ˆ';

    if (state.mode) {
      showDifficulty(state.mode);
    } else {
      showModeMenu();
    }

    // äº‹ä»¶ç»‘å®š
    document.querySelectorAll('.mode-btn').forEach(btn => {
      btn.onclick = () => showDifficulty(btn.dataset.mode);
    });
    document.querySelectorAll('.difficulty-btn').forEach(btn => {
      btn.onclick = () => startGame(+btn.dataset.d);
    });
    els.backBtn.onclick = () => {
      playSFX('click');
      if (els.play.style.display !== 'none') {
        showModal('ç¡®å®šæ”¾å¼ƒå½“å‰è¿›åº¦ï¼Ÿ', '', () => {
          els.play.style.display = 'none';
          els.difficultyMenu.style.display = '';
        }, () => {});
      } else {
        showModeMenu();
      }
    };
    els.soundBtn.onclick = () => {
      state.soundOn = !state.soundOn;
      els.soundBtn.textContent = state.soundOn ? 'ğŸ”Š' : 'ğŸ”‡';
      saveState();
      playSFX('click');
    };
    els.musicBtn.onclick = toggleBG;
    els.btnA.onclick = () => choose(0);
    els.btnB.onclick = () => choose(1);
    els.next.onclick = nextLevel;
    els.shareMain.onclick = shareGame;

    // é”®ç›˜æ”¯æŒ
    document.addEventListener('keydown', e => {
      if (els.play.style.display === 'none') return;
      if (e.key.toLowerCase() === 'a') els.btnA.click();
      if (e.key.toLowerCase() === 'b') els.btnB.click();
      if (e.key === 'Enter' && els.next.style.display !== 'none') els.next.click();
    });

    // åŠ¨ç”»å…¥åœº
    setTimeout(() => els.game.classList.add('ready'), 100);
  }

  init();
})();
</script>
</body>
</html>
